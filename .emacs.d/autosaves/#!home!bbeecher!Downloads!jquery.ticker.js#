$.fn.ticker = function(options) {
    cls = this;

    cls.options = {
        speed: 250,
        fade_in_speed: 250,
        interval_period: 750,
        showItems: 3,
        debug: false,
        element: "tr",
    }

    cls.options = $.extend(cls.options, options);

    cls.shiftElement = function(index, destination_y) {
        child = $(cls.children[index]);
        previous_y = child.position().top;
        child.animate({'top': destination_y + 'px'}, cls.options.speed);
        return previous_y;
    }

    cls.shiftDown = function() {
        clearInterval(cls.interval);

        end_idx = (cls.length - 1) - (cls.counter - 1) % cls.length;
        start_idx = (end_idx == cls.length -1 ? -1 : end_idx) + 1;

        if (cls.options.debug) {
            console.log("start_idx: " + start_idx);
            console.log("end_idx: " + end_idx);
        }

        // Get coordinates of first element
        first_child = $(cls.children[start_idx]);
        y = first_child.position().top;

        last_child = $(cls.children[end_idx]);
        last_y_pos = 0;
        last_height = last_child.height();
        last_child.fadeOut(function() {
            // Move bottom element to top
            last_child.css('top', "0");

            for (i=end_idx+1; i<cls.length; i++) {
                last_y_pos += last_height + 20;
                last_height = $(cls.children[i]).innerHeight();
                cls.shiftElement(i, last_y_pos);
            }

            for (i=0; i<end_idx; i++) {
                last_y_pos += last_height + 20;
                last_height = $(cls.children[i]).innerHeight();
                cls.shiftElement(i, last_y_pos);
            }

            last_child.fadeIn(cls.options.fade_in_speed, function() {
                cls.counter++;
                cls.start_interval();
            });
        });
    }

    cls.shiftUp = function() {
        clearInterval(cls.interval);

        start_idx = (cls.counter - 1) % cls.length;
        end_idx = (start_idx == 0 ? cls.length : start_idx) - 1

        // Get coordinates of last element;
        last_child = $(cls.children[end_idx]);
        y = last_child.position().top;

        first_child = $(cls.children[start_idx]);
        last_y_pos = first_child.position().top;
        first_child.fadeOut(function() {
            // Move top element to bottom
            first_child.css('top', y + "px");

            if (cls.options.debug) {
                console.log("start_idx: " + start_idx);
                console.log("end_idx: " + end_idx);
            }

            for (i=start_idx+1; i<cls.length; i++) {
                last_y_pos = cls.shiftElement(i, last_y_pos);
            }

            // Move all other elements up one
            for (i=0; i<start_idx; i++) {
                last_y_pos = cls.shiftElement(i, last_y_pos);
            }

            first_child.fadeIn(cls.options.fade_in_speed, function() {
                cls.counter++;
                cls.start_interval();
            });
        });
    }

    cls.start_interval = function() {
        cls.interval = setTimeout(function() {
            cls.shiftDown();
        }, cls.options.interval_period);
    }

    cls.init = function() {
        cls.children = $(cls).children(cls.options.element);
        cls.length = cls.children.length;
        cls.counter = 1;
        var positions = [];

        cls.children.each(function(i, item) {
            elem = $(cls.children[i]);
            position = elem.position();

            positions[i] = {
                'top': position.top,
                'left': position.left }
        });

        cls.children.each(function(i, item) {
            elem = $(cls.children[i]);
            elem.css('position', 'absolute');
            elem.css('top', positions[i]['top'] + "px");
            elem.css('left', positions[i]['left'] + "px");
        })

        cls.start_interval();
    }

    cls.init();
}

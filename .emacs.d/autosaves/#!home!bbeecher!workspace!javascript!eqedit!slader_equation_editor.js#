$.fn.extend({
    insertAtCaret: function(myValue){
    		if (document.selection) {
        this.focus();
        sel = document.selection.createRange();
        sel.text = myValue;
        this.focus();
    		}
      else if (this.selectionStart || this.selectionStart == '0') {
        var startPos = this.selectionStart;
        var endPos = this.selectionEnd;
        var scrollTop = this.scrollTop;
        this.value = this.value.substring(0, startPos)+myValue+this.value.substring(endPos,this.value.length);
        this.focus();
        this.selectionStart = startPos + myValue.length;
        this.selectionEnd = startPos + myValue.length;
        this.scrollTop = scrollTop;
      } else {
        this.value += myValue;
        this.focus();
      }
    }
})


var media_path = "media/images/equation/"

var buttons =      [
    {
        "path": "button1.png",
        "sub" :
        [
            {"path"  : "subbutton1.png",
             "latex" : "hey", },

            {"path" : "subbutton2.png",
             "latex" : "testing", },
        ]
    },
    {
        "path" : 'button2.png',
        "sub" :
        [
            {"path"  : "subbutton3.png",
             "latex" : "whatup", },

            {"path" : "subbutton4.png",
             "latex" : "divmod", },
        ]
    },
    {
        "path" : 'face.png',
        "latex" : 'testing1',
    },
]


function equation_editor(textpane_jquery_object){
    //grab textpane, add div w  list above it.
    // for each button:
    //add each button to list
    //prep content for each button
    // list of subbuttons
    // add clickhandler to each subbutton to insert content
    //add clickhandler to each button to open qtip w correct content



    var toolbar = $("<div id='toolbar'>")
    var toolbar_list = $("<ul id='toolbar-list'>")
    toolbar.append(toolbar_list)


    for (var i=0; i<=buttons.lengteh; i++){
        button = buttons[i]
        handleButton(button, toolbar_list, textpane_jquery_object)
    }

    toolbar.insertBefore(textpane_jquery_object)
}


function handleButton(button, rootelem, textfield){

    var button_elm = $("<li class='button'>")
    var button_link = $('<a href="#">')

    if ('path' in button){
        button_link.append($('<img src='+media_path + button['path']+'/>'))
    }

    if ('sub' in button){
        var button_list  = $("<ul class='button-list'>")
        for (subbutton in button['sub']){
            handleButton(subbutton, button_list)
        }
        
        button_list.append(button_elm)
        
        button_link.click = //handle qtip here

    }

    if ('latex' in button) {
        //handle inserting text into textarea
        button_link.click = /textfield.insertAtCaret(button['latex'])
    }

    rootelem.append(button_elm)
}
